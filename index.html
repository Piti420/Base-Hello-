<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hello Base World</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <div class="container">
    <img src="hello.png" alt="Hello Logo" class="logo" />

    <h1 class="title">Hello Base World</h1>

    <div class="buttons">
      <button id="connectWallet">Connect Wallet</button>
      <button id="greetButton">Greet Onchain</button>
      <button id="claimButton">Claim 100 HI</button>
    </div>

    <div id="status"></div>
    <div id="gmCount"></div>

    <div id="shareButtons" style="display: none">
      <p>âœ… Greeted successfully! Share it:</p>
      <a href="#" target="_blank" id="shareTwitter">Share on Twitter</a> |
      <a href="https://warpcast.com/~/compose?text=gm%20from%20Hello%20Base%20on%20Base!%20%F0%9F%9A%80" target="_blank">Share on Farcaster</a>
    </div>

    <footer>
      <p class="built">ðŸš€ Built on Base</p>
    </footer>
  </div>

  <script>
    let provider;
    let signer;
    let userAddress;

    const GM_CONTRACT = "0x06B17752e177681e5Df80e0996228D7d1dB2F61b";
    const HI_TOKEN_CONTRACT = "0xdEeBc11cB7eDAe91aD9a6165ab385B6D04a839E0";

    const gmABI = [
      "function gm() public",
      "function getGMCount(address) view returns (uint256)"
    ];

    const hiABI = [
      "function claim() public",
      "function claimed(address) view returns (bool)"
    ];

    async function connectWallet() {
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("status").innerText = `Connected: ${userAddress}`;
        updateGMCount();
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Wallet connection failed.";
      }
    }

    async function greetOnchain() {
      try {
        const contract = new ethers.Contract(GM_CONTRACT, gmABI, signer);
        const tx = await contract.gm();
        await tx.wait();
        document.getElementById("status").innerText = "âœ… Greeted onchain!";
        document.getElementById("shareButtons").style.display = "block";
        document.getElementById("shareTwitter").href = `https://twitter.com/intent/tweet?text=gm%20from%20Hello%20Base%20on%20Base!%20%F0%9F%9A%80`;
        updateGMCount();
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "âŒ Failed to send GM. Make sure wallet is connected and try again.";
      }
    }

    async function claimHI() {
      try {
        const contract = new ethers.Contract(HI_TOKEN_CONTRACT, hiABI, signer);
        const alreadyClaimed = await contract.claimed(userAddress);
        if (alreadyClaimed) {
          document.getElementById("status").innerText = "You already claimed your 100 HI.";
          return;
        }
        const tx = await contract.claim();
        await tx.wait();
        document.getElementById("status").innerText = "âœ… Claimed 100 HI!";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "âŒ Claim failed. Make sure wallet is connected and try again.";
      }
    }

    async function updateGMCount() {
      try {
        const contract = new ethers.Contract(GM_CONTRACT, gmABI, provider);
        const count = await contract.getGMCount(userAddress);
        document.getElementById("gmCount").innerText = `Total GM's: ${count.toString()}`;
      } catch (err) {
        console.error(err);
        document.getElementById("gmCount").innerText = "";
      }
    }

    // Event listeners
    window.addEventListener("load", async () => {
      if (window.ethereum) {
        await connectWallet();
      }
    });

    document.getElementById("connectWallet").addEventListener("click", connectWallet);
    document.getElementById("greetButton").addEventListener("click", greetOnchain);
    document.getElementById("claimButton").addEventListener("click", claimHI);
  </script>
</body>
</html>
